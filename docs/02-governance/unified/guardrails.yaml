# Guardrails - Safety Rules for AI Agents
# Version: 3.0
# Part of: AI Team Governance (AI-TEAM-SPEC-V3)

version: "3.0"
description: "Defines forbidden patterns and behavioral rules for AI agents"

# ═══════════════════════════════════════════════════════════════════════════════
# FORBIDDEN PATTERNS
# Ralph will BLOCK commits containing these patterns
# ═══════════════════════════════════════════════════════════════════════════════

forbidden_patterns:
  # ─────────────────────────────────────────────────────────────────────────────
  # TypeScript/JavaScript
  # ─────────────────────────────────────────────────────────────────────────────
  typescript:
    - pattern: "@ts-ignore"
      message: "Fix the type error instead of ignoring it"
      severity: "BLOCK"

    - pattern: "@ts-nocheck"
      message: "Type checking must remain enabled"
      severity: "BLOCK"

    - pattern: "@ts-expect-error"
      message: "Fix the underlying type issue"
      severity: "BLOCK"

    - pattern: "as any"
      message: "Avoid type assertions to 'any'; use proper typing"
      severity: "WARN"
      context: "type assertion"

  # ─────────────────────────────────────────────────────────────────────────────
  # ESLint
  # ─────────────────────────────────────────────────────────────────────────────
  eslint:
    - pattern: "eslint-disable"
      message: "Fix the lint error instead of disabling the rule"
      severity: "BLOCK"

    - pattern: "eslint-disable-next-line"
      message: "Fix the lint error instead of disabling for this line"
      severity: "BLOCK"

    - pattern: "eslint-disable-line"
      message: "Fix the lint error instead of disabling inline"
      severity: "BLOCK"

  # ─────────────────────────────────────────────────────────────────────────────
  # Testing
  # ─────────────────────────────────────────────────────────────────────────────
  testing:
    - pattern: ".skip("
      message: "Do not skip tests; fix or remove them"
      severity: "BLOCK"

    - pattern: ".only("
      message: "Do not focus tests; all tests must run"
      severity: "BLOCK"

    - pattern: "test.todo("
      message: "Implement the test or remove the todo"
      severity: "WARN"

    - pattern: "it.todo("
      message: "Implement the test or remove the todo"
      severity: "WARN"

    - pattern: "describe.skip("
      message: "Do not skip test suites"
      severity: "BLOCK"

  # ─────────────────────────────────────────────────────────────────────────────
  # Git
  # ─────────────────────────────────────────────────────────────────────────────
  git:
    - pattern: "--no-verify"
      message: "Never bypass pre-commit hooks"
      severity: "BLOCK"
      context: "git commit"

    - pattern: "-n"
      message: "Never bypass verification with short flag"
      severity: "BLOCK"
      context: "git commit"

    - pattern: "--force"
      message: "Force push requires human approval"
      severity: "BLOCK"
      context: "git push"

  # ─────────────────────────────────────────────────────────────────────────────
  # Python
  # ─────────────────────────────────────────────────────────────────────────────
  python:
    - pattern: "# noqa"
      message: "Fix the lint issue instead of ignoring"
      severity: "BLOCK"

    - pattern: "# type: ignore"
      message: "Fix the type error instead of ignoring"
      severity: "BLOCK"

    - pattern: "@pytest.mark.skip"
      message: "Do not skip tests; fix or remove them"
      severity: "BLOCK"

    - pattern: "pytest.skip("
      message: "Do not skip tests programmatically"
      severity: "WARN"

  # ─────────────────────────────────────────────────────────────────────────────
  # Console/Debug
  # ─────────────────────────────────────────────────────────────────────────────
  console:
    - pattern: "console.log("
      message: "Remove debug console.log statements"
      severity: "WARN"
      exceptions:
        - "**/*.test.ts"
        - "**/*.spec.ts"
        - "**/scripts/**"

    - pattern: "debugger"
      message: "Remove debugger statements"
      severity: "BLOCK"

    - pattern: "print("
      message: "Use logging instead of print statements"
      severity: "WARN"
      context: "python"
      exceptions:
        - "**/scripts/**"
        - "**/cli/**"

# ═══════════════════════════════════════════════════════════════════════════════
# BEHAVIORAL RULES
# Enforced by agent contracts and stop hooks
# ═══════════════════════════════════════════════════════════════════════════════

behavioral_rules:
  # ─────────────────────────────────────────────────────────────────────────────
  # Advisor Rules
  # ─────────────────────────────────────────────────────────────────────────────
  advisors:
    - rule: "no_implementation"
      description: "Advisors cannot write application code"
      message: "Advisors analyze and recommend; they do not implement"
      enforcement: "contract"

    - rule: "must_document"
      description: "All decisions must be documented in ADR"
      message: "Create ADR for every decision made"
      enforcement: "contract"

    - rule: "must_check_existing_adrs"
      description: "Must check for existing ADRs before making decisions"
      message: "Read AI-Team-Plans/decisions/ before deciding"
      enforcement: "behavioral"

    - rule: "escalate_on_conflict"
      description: "Must escalate when proposed decision conflicts with ADR"
      message: "Cannot override existing ADR without human approval"
      enforcement: "contract"

  # ─────────────────────────────────────────────────────────────────────────────
  # Coordinator Rules
  # ─────────────────────────────────────────────────────────────────────────────
  coordinator:
    - rule: "no_code_changes"
      description: "Coordinator orchestrates; does not write code"
      message: "Coordinator manages tasks and status, not implementation"
      enforcement: "contract"

    - rule: "must_update_project_hq"
      description: "Every action must update PROJECT_HQ.md"
      message: "PROJECT_HQ must always reflect current state"
      enforcement: "contract"

    - rule: "respect_dependencies"
      description: "Tasks must respect declared dependencies"
      message: "Cannot assign task until dependencies complete"
      enforcement: "behavioral"

    - rule: "log_all_events"
      description: "All significant events must be logged"
      message: "Events provide audit trail and observability"
      enforcement: "contract"

  # ─────────────────────────────────────────────────────────────────────────────
  # Builder Rules (QA Team)
  # ─────────────────────────────────────────────────────────────────────────────
  qa_team:
    - rule: "test_count_unchanged"
      description: "QA team cannot reduce test count"
      message: "Fixing tests must not remove test cases"
      enforcement: "ralph"

    - rule: "no_new_files"
      description: "QA team cannot create new feature files"
      message: "QA team maintains; does not build features"
      enforcement: "contract"

    - rule: "behavior_preserved"
      description: "Must not change application behavior"
      message: "QA fixes do not alter functionality"
      enforcement: "ralph"

  # ─────────────────────────────────────────────────────────────────────────────
  # Builder Rules (Dev Team)
  # ─────────────────────────────────────────────────────────────────────────────
  dev_team:
    - rule: "tests_required"
      description: "New code must have tests"
      message: "All new functionality requires test coverage"
      enforcement: "ralph"

    - rule: "coverage_minimum"
      description: "Minimum 80% coverage on new files"
      value: 80
      message: "New files must meet coverage threshold"
      enforcement: "ralph"

    - rule: "feature_branch_only"
      description: "Dev team works on feature/* branches only"
      message: "Cannot push to main or fix/* branches"
      enforcement: "contract"

# ═══════════════════════════════════════════════════════════════════════════════
# HIPAA RULES (CredentialMate Extension)
# ═══════════════════════════════════════════════════════════════════════════════

hipaa_rules:
  enabled_for:
    - credentialmate

  patterns:
    - pattern: "patient"
      context: "hardcoded string literal"
      message: "No hardcoded PHI - use environment variables or secure storage"
      severity: "BLOCK"

    - pattern: "ssn"
      context: "hardcoded string literal"
      message: "No hardcoded SSN data"
      severity: "BLOCK"

    - pattern: "social.security"
      context: "hardcoded string literal"
      message: "No hardcoded social security data"
      severity: "BLOCK"

    - pattern: "medical"
      context: "hardcoded string literal"
      message: "No hardcoded medical data"
      severity: "WARN"

    - pattern: "diagnosis"
      context: "hardcoded string literal"
      message: "No hardcoded diagnosis data"
      severity: "WARN"

  sensitive_paths:
    - "**/models/patient*"
    - "**/models/credential*"
    - "**/api/health*"
    - "**/services/hipaa*"

# ═══════════════════════════════════════════════════════════════════════════════
# HEALTHCARE RULES (KareMatch Extension)
# ═══════════════════════════════════════════════════════════════════════════════

healthcare_rules:
  enabled_for:
    - karematch

  patterns:
    - pattern: "caregiver_ssn"
      message: "Use encrypted storage for caregiver SSN"
      severity: "BLOCK"

    - pattern: "background_check"
      context: "hardcoded result"
      message: "Background check results must be from verified source"
      severity: "BLOCK"

  sensitive_paths:
    - "**/services/matching/**"
    - "**/models/caregiver*"
    - "**/models/family*"

# ═══════════════════════════════════════════════════════════════════════════════
# ENFORCEMENT CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════

enforcement:
  # Severity levels
  severity_levels:
    BLOCK: "Prevents commit/action; must be fixed"
    WARN: "Logs warning; action proceeds"
    INFO: "Informational; no blocking"

  # When to run checks
  timing:
    advisors: "none"          # Advisors don't write code
    coordinator: "none"       # Coordinator doesn't write code
    qa_team: "every_commit"   # Strict verification
    dev_team: "on_pr"         # Relaxed for iteration speed

  # Integration with Ralph
  ralph_integration:
    enabled: true
    block_on_violation: true
    report_warnings: true
