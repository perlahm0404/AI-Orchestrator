# Dev Team Autonomy Contract
#
# Defines what the Dev Team agents can and cannot do.
# Dev Team builds NEW features on feature/* branches only.
# Stricter than QA Team - new code requires more oversight.
#
# Enforced at runtime by governance hooks.

agent: dev-team
version: "1.0"
team: development

# L1 = Stricter autonomy (more human review for new code)
# L2 = Higher autonomy (QA Team)
autonomy_level: L1

description: |
  Dev Team builds new features in isolation on feature branches.
  Code is only merged to main after Ralph verification passes.
  New functionality requires approval for certain operations.

# Branch restrictions - Dev Team ONLY works on feature branches
branch_restrictions:
  allowed_patterns:
    - "feature/*"
  forbidden_patterns:
    - "main"
    - "master"
    - "fix/*"
    - "hotfix/*"

allowed_actions:
  # File operations
  - read_file
  - write_file
  - create_file
  - delete_file  # Can delete files they created

  # Code quality
  - run_tests
  - run_lint
  - run_typecheck
  - run_ralph  # Only at PR time, not every commit

  # Git operations
  - create_branch
  - commit_changes
  - push_feature_branch
  - create_pr
  - rebase_from_main

  # Database (read-only for context)
  - read_database

  # Learning
  - consult_knowledge_objects
  - create_knowledge_object_draft

forbidden_actions:
  # Production safety
  - modify_migrations      # Schema changes require human review
  - modify_ci_config       # CI changes require human review
  - push_to_main           # Never push directly to main
  - push_to_fix_branch     # Stay in your lane (QA Team's territory)
  - deploy                 # Never deploy

  # Test integrity
  - delete_existing_tests  # Can skip with .todo, cannot delete
  - modify_test_snapshots  # Can regenerate, not modify

  # Governance
  - modify_governance      # Cannot change own rules
  - bypass_ralph           # No --no-verify
  - use_no_verify          # Explicit ban on git commit flags

# These actions require human approval before proceeding
requires_approval:
  - add_new_dependency     # New npm/pip packages
  - new_api_endpoint       # Public API surface changes
  - schema_changes         # Database schema modifications
  - external_api_integration  # Third-party API calls
  - merge_pr               # Final merge requires approval
  - security_sensitive     # Auth, crypto, PII handling

# Higher limits than QA Team (features are larger than fixes)
limits:
  max_lines_added: 500
  max_lines_deleted: 200
  max_files_changed: 20
  max_new_files: 10
  max_commits_per_session: 20
  max_retries: 5
  max_iterations: 50  # Ralph-Wiggum iteration budget (liberal for feature development)

# Conditions that halt the agent immediately
halt_conditions:
  - ralph_blocked          # Ralph returned BLOCKED verdict
  - approval_required      # Hit a requires_approval item
  - test_regression        # Existing tests started failing
  - branch_violation       # Attempted to work on wrong branch
  - security_violation     # Attempted forbidden security operation

# What to do on different violation types
on_violation:
  forbidden_action: halt
  limit_exceeded: warn
  branch_violation: halt
  approval_required: pause  # Pause and wait for approval

# Ralph verification settings for Dev Team
ralph_settings:
  # Don't run Ralph on every commit (too slow for feature dev)
  verify_on_commit: false
  # Always run Ralph before PR merge
  verify_on_pr: true
  # Required checks for PR approval
  required_checks:
    - lint
    - typecheck
    - test
  # Optional checks (nice to have)
  optional_checks:
    - coverage

# Test requirements for new features
test_requirements:
  # New code must have tests
  require_tests_for_new_code: true
  # Minimum coverage for new files
  min_coverage_new_files: 80
  # Can use .todo for work-in-progress tests
  allow_todo_tests: true
  # Cannot skip tests in final PR
  allow_skip_in_pr: false

# Handoff protocol when feature is complete
handoff:
  # Required artifacts before PR
  required_artifacts:
    - feature_handoff_doc
    - test_report
    - ralph_pass_evidence
  # Notify QA Team after merge
  notify_on_merge:
    - qa-team
  # Feature becomes QA Team scope after merge
  transfer_ownership_on_merge: true
