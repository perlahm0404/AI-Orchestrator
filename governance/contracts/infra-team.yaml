# Infra Team Autonomy Contract
#
# Defines what Infrastructure/DevOps agents can do.
# Infra Team manages Docker, environment configuration, service orchestration.
# Highest scrutiny - configuration errors break golden pathway silently.
#
# Created: 2026-01-08 (from golden pathway incident lessons)
# Enforced at runtime by governance hooks.

agent: infra-team
version: "1.0"
team: infrastructure

# L0 = Strictest autonomy (infrastructure changes are high-risk)
autonomy_level: L0

description: |
  Infra Team manages infrastructure configuration and deployment automation.
  CRITICAL: Configuration drift breaks golden pathway silently (S3 bucket mismatches).
  All changes require validation against Service Contracts SSOT.
  Human review required for all merges.

# Branch restrictions - Can work on infrastructure branches only
branch_restrictions:
  allowed_patterns:
    - "infra/*"
    - "devops/*"
    - "config/*"
  forbidden_patterns:
    - "main"          # Requires PR approval
    - "feature/*"     # Dev Team territory
    - "fix/*"         # QA Team territory

allowed_actions:
  # File operations
  - read_file
  - write_file        # Modify infrastructure files

  # Infrastructure operations
  - modify_docker_compose
  - modify_env_files
  - modify_service_contracts
  - modify_localstack_init
  - modify_ci_config
  - modify_deployment_scripts

  # Validation (MANDATORY before commit)
  - run_yaml_syntax_check
  - run_service_contract_validation
  - run_env_preflight_validation
  - run_golden_path_test

  # Git operations
  - create_infra_branch
  - commit_changes
  - push_infra_branch
  - create_pr

  # Database (read-only)
  - read_database

forbidden_actions:
  # Code safety
  - modify_application_code     # Not in Infra scope
  - modify_tests                # Not in Infra scope
  - modify_migrations           # Schema changes require human review

  # Direct deployment
  - push_to_main_direct         # Must go through PR
  - deploy_without_approval     # Requires human approval

  # Governance
  - bypass_validation           # Cannot skip pre-commit checks
  - use_no_verify               # Never bypass hooks
  - modify_own_contract         # Cannot change own rules

# ALL infrastructure changes require human approval before merge
requires_approval:
  - merge_pr                      # Final merge always requires approval
  - modify_production_env         # Production environment changes
  - modify_docker_compose_prod    # Production orchestration
  - modify_lambda_template        # AWS Lambda configuration
  - add_new_service               # New Docker services
  - change_service_contract       # SSOT modifications

# Strict limits - infrastructure changes should be small and focused
limits:
  max_lines_added: 200
  max_lines_deleted: 100
  max_files_changed: 10
  max_commits_per_session: 5
  max_retries: 3
  max_iterations: 15  # Ralph-Wiggum iteration budget

# Conditions that halt the agent immediately
halt_conditions:
  - yaml_syntax_error             # Invalid docker-compose.yml
  - service_contract_violation    # SSOT mismatch detected
  - env_preflight_failure         # Pre-flight validation failed
  - golden_path_regression        # Golden pathway test failed
  - approval_required             # Requires human decision

# What to do on different violation types
on_violation:
  forbidden_action: halt
  limit_exceeded: halt          # Stricter than other teams
  validation_failure: halt      # CRITICAL - never bypass
  approval_required: pause

# Mandatory Pre-Commit Validations
pre_commit_validation:
  description: |
    CRITICAL: These validations MUST pass before any commit.
    Prevents configuration drift and golden pathway regressions.

  mandatory_checks:
    - name: "yaml_syntax"
      command: "docker compose config --quiet"
      description: "Validate YAML syntax in docker-compose files"
      on_failure: "BLOCK"

    - name: "env_preflight"
      command: "python infra/scripts/validate_env_preflight.py"
      description: "Validate environment variable configuration"
      on_failure: "BLOCK"

    - name: "service_contracts"
      command: "python infra/scripts/validate_service_contracts.py"
      description: "Validate all service contracts against SSOT"
      on_failure: "BLOCK"
      required_for:
        - "docker-compose*.yml"
        - "**/.env*"
        - "infra/docker/localstack-init/**"
        - "infra/config/service-contracts.yaml"

    - name: "golden_path_health"
      command: "docker compose up -d && sleep 30 && python infra/scripts/test_golden_path.py --health-only"
      description: "Verify golden pathway still functional"
      timeout: 180
      on_failure: "BLOCK"
      required_for:
        - "docker-compose*.yml"
        - "infra/docker/localstack-init/**"
        - "**/.env*"

  post_commit_recommended:
    - name: "full_golden_path"
      command: "python infra/scripts/test_golden_path.py --full"
      description: "Full golden pathway test with contract validation"
      timeout: 300

# Service Contract Rules (CRITICAL)
service_contract_rules:
  description: |
    Service contracts are the SSOT for cross-service configuration.
    S3 bucket names, DB URLs, Redis connections MUST match across all files.

  ssot_file: "infra/config/service-contracts.yaml"

  protected_contracts:
    # S3 Configuration
    - name: "s3.documents_bucket"
      reason: "Mismatches cause DocumentFileMissing errors"
      must_match_in:
        - "apps/backend-api/.env.local"
        - "docker-compose.yml (services.worker.environment)"
        - "infra/docker/localstack-init/01-create-buckets.sh"

    - name: "s3.endpoint_url"
      reason: "Wrong endpoint routes to AWS instead of LocalStack"
      must_match_in:
        - "apps/backend-api/.env.local"
        - "docker-compose.yml (services.backend.environment)"
        - "docker-compose.yml (services.worker.environment)"

    # Database Configuration
    - name: "database.connection_url"
      reason: "Connection failures break entire application"
      must_match_in:
        - "apps/backend-api/.env.local"
        - "docker-compose.yml (services.backend.environment)"

    # Redis Configuration
    - name: "redis.connection_url"
      reason: "Celery worker failures break document processing"
      must_match_in:
        - "apps/backend-api/.env.local"
        - "docker-compose.yml (services.backend.environment)"

  update_procedure:
    steps:
      - "1. Update SSOT: infra/config/service-contracts.yaml"
      - "2. Run validation: python infra/scripts/validate_service_contracts.py"
      - "3. Update all mismatches reported by validator"
      - "4. Re-run validation until all pass"
      - "5. Test golden pathway: python infra/scripts/test_golden_path.py --pre-commit"
      - "6. Commit only after ALL validations pass"

# Golden Pathway Protection (CRITICAL)
golden_pathway_protection:
  description: |
    Infrastructure changes are the #1 cause of golden pathway regressions.
    Bucket name mismatches, env var errors break uploadâ†’review flow silently.

  critical_infrastructure_files:
    - path: "docker-compose.yml"
      risk: "CRITICAL"
      reason: "Env var mismatches cause silent failures"

    - path: "docker-compose.prod.yml"
      risk: "CRITICAL"
      reason: "Production orchestration - requires extra scrutiny"

    - path: "infra/docker/localstack-init/01-create-buckets.sh"
      risk: "CRITICAL"
      reason: "Bucket name mismatches break golden pathway"

    - path: "apps/backend-api/.env.local"
      risk: "HIGH"
      reason: "Environment configuration for local development"

    - path: "infra/config/service-contracts.yaml"
      risk: "CRITICAL"
      reason: "SSOT for all cross-service contracts"

    - path: "infra/lambda/template.yaml"
      risk: "CRITICAL"
      reason: "AWS Lambda deployment configuration"

  mandatory_tests:
    - "Service contract validation MUST pass"
    - "Pre-flight validation MUST pass"
    - "Golden path test MUST pass"
    - "YAML syntax check MUST pass"

  forbidden_patterns:
    - pattern: "--no-verify"
      action: "BLOCK"
      reason: "Never bypass pre-commit hooks"

    - pattern: "git commit -n"
      action: "BLOCK"
      reason: "Never bypass pre-commit hooks"

    - pattern: "SKIP_PREFLIGHT=true"
      action: "WARN"
      reason: "Emergency bypass - use only when absolutely necessary"

# Alerting on Infrastructure Changes
alerts:
  on_pr_create:
    notify: ["@devops-team", "@platform-team"]
    message: "Infrastructure PR created - requires review"

  on_validation_failure:
    slack_channel: "#infra-alerts"
    create_github_issue: true
    priority: "P0"
    message: "Infrastructure validation failed - golden pathway may be broken"

  on_golden_path_failure:
    slack_channel: "#incidents"
    create_github_issue: true
    priority: "P0"
    labels: ["golden-path", "regression", "infra"]
    message: "Golden pathway BROKEN after infrastructure change"

# Recovery Procedures
recovery:
  on_golden_path_failure:
    steps:
      - "1. Immediately revert last infrastructure commit"
      - "2. Run: python infra/scripts/validate_service_contracts.py --verbose"
      - "3. Fix all contract violations reported"
      - "4. Run: python infra/scripts/test_golden_path.py --pre-commit"
      - "5. If pass, re-apply changes with fixes"
      - "6. Document root cause in sessions/"

  on_service_contract_violation:
    steps:
      - "1. Review validator output for mismatches"
      - "2. Update incorrect file to match SSOT"
      - "3. OR update SSOT if it's wrong"
      - "4. Re-run: python infra/scripts/validate_service_contracts.py"
      - "5. Continue only after ALL pass"

# Metrics tracking
metrics:
  track:
    - infrastructure_changes
    - validation_failures
    - golden_path_regressions_prevented
    - service_contract_violations_caught
    - yaml_syntax_errors_caught
  report_frequency: per_session
  alert_on:
    - golden_path_regression
    - service_contract_violation
