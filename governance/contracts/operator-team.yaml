# Operator Team Autonomy Contract
#
# Defines what Deployment/Operations agents can do.
# Operator Team manages deployments, migrations, and production operations.
# STRICTEST autonomy - production deployments are high-risk and irreversible.
#
# Created: 2026-01-10 (Phase 2 - Safe Deployments)
# Enforced at runtime by governance hooks.

agent: operator-team
version: "1.0"
team: operations

# L0.5 = Strictest autonomy (even stricter than Infra Team)
# Production deployments require human approval ALWAYS
autonomy_level: L0.5

description: |
  Operator Team manages deployments, database migrations, and production operations.
  CRITICAL: Deployment errors can cause data loss, downtime, or security breaches.
  All production operations require human approval.
  Automatic rollback for dev/staging, manual approval for production rollback.

# Branch restrictions - Can work on deployment branches only
branch_restrictions:
  allowed_patterns:
    - "deploy/*"
    - "migration/*"
    - "ops/*"
  forbidden_patterns:
    - "main"        # Requires PR approval
    - "feature/*"   # Dev Team territory
    - "fix/*"       # QA Team territory
    - "infra/*"     # Infra Team territory

# Environment-based autonomy gates
environment_gates:
  development:
    auto_deploy: true
    auto_rollback: true
    approval_required: false
    description: "Full autonomy in dev environment"

  staging:
    auto_deploy: false  # First-time approval required
    auto_rollback: true
    approval_required: true  # First deployment requires approval
    approval_type: "first_time_only"
    description: "Requires approval for first deployment, then auto-deploys"

  production:
    auto_deploy: false
    auto_rollback: false
    approval_required: true  # ALWAYS requires approval
    approval_type: "always"
    description: "ALWAYS requires human approval before any operation"

allowed_actions:
  # File operations
  - read_file
  - write_deployment_logs

  # Deployment operations (environment-gated)
  - build_application
  - run_tests_pre_deploy
  - deploy_to_dev
  - deploy_to_staging      # First-time approval required
  - deploy_to_production   # ALWAYS requires approval

  # Migration operations (CRITICAL)
  - validate_migration
  - run_migration_dev
  - run_migration_staging   # First-time approval required
  - run_migration_production  # ALWAYS requires approval

  # Rollback operations
  - rollback_dev           # Auto-rollback allowed
  - rollback_staging       # Auto-rollback allowed
  - rollback_production    # ALWAYS requires approval

  # Monitoring
  - check_deployment_health
  - read_logs
  - read_metrics
  - create_deployment_report

  # Git operations
  - create_deploy_branch
  - commit_deployment_metadata
  - tag_release

forbidden_actions:
  # SQL operations that are IRREVERSIBLE
  - drop_database          # NEVER drop databases
  - drop_table             # NEVER drop tables
  - truncate_table         # NEVER truncate tables
  - delete_without_where   # NEVER delete all rows

  # S3 operations that are IRREVERSIBLE
  - delete_s3_bucket       # NEVER delete buckets
  - delete_all_s3_objects  # NEVER delete all objects in bucket

  # Direct production access
  - ssh_to_production      # No direct SSH access
  - modify_production_db   # No direct DB modifications
  - bypass_deployment_pipeline  # Must use deployment orchestrator

  # Code modifications
  - modify_application_code  # Not in Operator scope
  - modify_tests            # Not in Operator scope
  - modify_infrastructure   # Infra Team territory

  # Governance
  - bypass_validation       # Cannot skip checks
  - use_no_verify          # Never bypass hooks
  - skip_approval          # Cannot skip approval gates

# ALL deployment operations require specific approvals
requires_approval:
  # Production operations ALWAYS require approval
  - deploy_to_production
  - run_migration_production
  - rollback_production
  - modify_production_secrets

  # Staging operations require first-time approval
  - deploy_to_staging_first_time
  - run_migration_staging_first_time

  # AWS provisioning requires business case
  - provision_new_aws_resource
  - modify_aws_iam_policy
  - create_s3_bucket
  - create_rds_instance
  - create_lambda_function

# AWS Provisioning Business Case Requirements
aws_provisioning:
  description: |
    All AWS resource provisioning requires a business case with:
    - Justification: Why is this resource needed?
    - Cost estimate: What will this cost monthly/annually?
    - Alternatives: What alternatives were considered?
    - Risks: What are the security/operational risks?

  required_documentation:
    - justification
    - cost_estimate
    - alternatives_considered
    - risk_assessment
    - approval_from_human

  cost_threshold:
    auto_approve: "$0"      # Never auto-approve
    requires_review: "$1+"  # All costs require review
    requires_cto: "$500+/month"

# Strict limits - deployments should be atomic and focused
limits:
  max_deployment_time: 1800  # 30 minutes max
  max_migration_time: 600    # 10 minutes max
  max_rollback_time: 300     # 5 minutes max
  max_retries: 2             # Limited retries for deployments
  max_iterations: 10         # Ralph-Wiggum iteration budget

# Conditions that halt the agent immediately
halt_conditions:
  - deployment_failure         # Deployment failed
  - migration_failure          # Migration failed
  - health_check_failure       # Post-deployment health check failed
  - approval_required          # Requires human decision
  - sql_safety_violation       # Forbidden SQL pattern detected
  - s3_safety_violation        # Forbidden S3 operation detected
  - irreversible_migration     # Migration has no downgrade() method
  - production_gate            # Production operation attempted

# What to do on different violation types
on_violation:
  forbidden_action: halt_and_alert
  limit_exceeded: halt
  sql_safety_violation: halt_and_alert
  s3_safety_violation: halt_and_alert
  approval_required: pause_and_request
  deployment_failure: auto_rollback_if_allowed

# SQL Safety Rules (CRITICAL)
sql_safety:
  description: |
    Prevents irreversible SQL operations that can cause data loss.
    All SQL in migrations is scanned before execution.

  forbidden_patterns:
    - pattern: "DROP DATABASE"
      risk: "CRITICAL"
      reason: "Irreversible data loss"
      action: "BLOCK"

    - pattern: "DROP TABLE"
      risk: "CRITICAL"
      reason: "Irreversible data loss"
      action: "BLOCK"

    - pattern: "TRUNCATE TABLE"
      risk: "CRITICAL"
      reason: "Irreversible data deletion"
      action: "BLOCK"

    - pattern: "DELETE FROM .* WHERE"
      risk: "HIGH"
      reason: "Potential data loss - requires WHERE clause validation"
      action: "WARN"

    - pattern: "DELETE FROM .*(?!WHERE)"
      risk: "CRITICAL"
      reason: "DELETE without WHERE clause - deletes all rows"
      action: "BLOCK"

    - pattern: "UPDATE .* SET .*(?!WHERE)"
      risk: "HIGH"
      reason: "UPDATE without WHERE clause - affects all rows"
      action: "WARN"

  required_validations:
    - "Migration must have downgrade() method"
    - "No DROP TABLE in production migrations"
    - "No TRUNCATE in production migrations"
    - "All DELETE/UPDATE must have WHERE clauses"

# S3 Safety Rules (CRITICAL)
s3_safety:
  description: |
    Prevents irreversible S3 operations that can cause data loss.
    All S3 operations in code are scanned before deployment.

  forbidden_patterns:
    - pattern: "s3.*delete_bucket"
      risk: "CRITICAL"
      reason: "Irreversible bucket deletion"
      action: "BLOCK"

    - pattern: "s3.*delete_objects.*Bucket"
      risk: "CRITICAL"
      reason: "Bulk object deletion"
      action: "WARN"

    - pattern: "boto3.*delete_bucket"
      risk: "CRITICAL"
      reason: "Irreversible bucket deletion"
      action: "BLOCK"

    - pattern: "awslocal s3 rb"
      risk: "HIGH"
      reason: "Remove bucket command"
      action: "WARN"

  required_validations:
    - "No bucket deletion in production code"
    - "Object deletion must be reversible (soft delete preferred)"
    - "Bulk operations require approval"

# Migration Validation (CRITICAL)
migration_validation:
  description: |
    All Alembic migrations must be reversible and safe.
    Migrations without downgrade() methods are BLOCKED in production.

  required_elements:
    - upgrade: true
    - downgrade: true
    - description: true
    - revision: true

  forbidden_in_production:
    - "DROP TABLE"
    - "TRUNCATE"
    - "DELETE without WHERE"
    - "Migrations without downgrade()"

  validation_steps:
    - "Check for downgrade() method"
    - "Scan SQL for forbidden patterns"
    - "Validate migration reversibility"
    - "Check for data loss risks"
    - "Require human approval for production"

# Deployment Workflow
deployment_workflow:
  description: |
    Structured deployment process with gates and validations.

  pre_deployment:
    - "Run all tests (unit, integration, e2e)"
    - "Validate migrations (if any)"
    - "Check for SQL/S3 safety violations"
    - "Build application"
    - "Tag release in git"

  deployment:
    - "Deploy to environment (dev/staging/prod)"
    - "Run database migrations (if any)"
    - "Wait for health checks to pass"
    - "Validate deployment success"

  post_deployment:
    - "Run smoke tests"
    - "Check application metrics"
    - "Monitor error rates"
    - "Create deployment report"

  on_failure:
    dev: "Auto-rollback immediately"
    staging: "Auto-rollback immediately"
    production: "Halt and request human decision on rollback"

# Auto-Rollback Configuration
auto_rollback:
  enabled_environments:
    - development
    - staging

  disabled_environments:
    - production  # Production rollback requires approval

  triggers:
    - deployment_failure
    - health_check_failure
    - error_rate_spike
    - critical_metric_degradation

  rollback_steps:
    - "Stop new deployment"
    - "Revert to previous version"
    - "Run health checks"
    - "Notify team of rollback"
    - "Create incident report"

# Alerting on Deployment Operations
alerts:
  on_production_deployment:
    notify: ["@ops-team", "@platform-team", "@cto"]
    message: "Production deployment initiated - requires approval"
    priority: "P1"

  on_deployment_failure:
    slack_channel: "#incidents"
    pagerduty: true
    create_github_issue: true
    priority: "P0"
    message: "Deployment FAILED"

  on_sql_safety_violation:
    slack_channel: "#security-alerts"
    create_github_issue: true
    priority: "P0"
    labels: ["security", "sql-safety", "blocked"]
    message: "BLOCKED: Forbidden SQL pattern detected in migration"

  on_s3_safety_violation:
    slack_channel: "#security-alerts"
    create_github_issue: true
    priority: "P0"
    labels: ["security", "s3-safety", "blocked"]
    message: "BLOCKED: Forbidden S3 operation detected"

  on_auto_rollback:
    slack_channel: "#deployments"
    message: "Auto-rollback executed in {environment}"
    priority: "P1"

# Recovery Procedures
recovery:
  on_deployment_failure:
    steps:
      - "1. Check deployment logs for error details"
      - "2. Determine if auto-rollback is allowed (dev/staging)"
      - "3. If production, request human decision (R/O/A)"
      - "4. If rollback approved, execute rollback"
      - "5. Run health checks post-rollback"
      - "6. Document incident in sessions/"

  on_migration_failure:
    steps:
      - "1. HALT immediately - do not continue"
      - "2. Check migration logs for SQL errors"
      - "3. Validate migration downgrade() method exists"
      - "4. If production, request human decision"
      - "5. Run downgrade() to rollback migration"
      - "6. Validate database state"
      - "7. Document incident and root cause"

  on_sql_safety_violation:
    steps:
      - "1. BLOCK deployment immediately"
      - "2. Alert security team"
      - "3. Review migration for forbidden patterns"
      - "4. Require human review of SQL"
      - "5. Update migration to remove violation"
      - "6. Re-validate before allowing deployment"

# Metrics tracking
metrics:
  track:
    - deployments_total
    - deployments_successful
    - deployments_failed
    - auto_rollbacks
    - manual_rollbacks
    - migrations_run
    - sql_safety_violations_blocked
    - s3_safety_violations_blocked
    - deployment_duration_seconds
  report_frequency: per_deployment
  alert_on:
    - deployment_failure
    - sql_safety_violation
    - s3_safety_violation
    - migration_failure
