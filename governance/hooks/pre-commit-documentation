#!/bin/bash
# Git Pre-Commit Hook: Documentation Structure Validator (ADR-010)
#
# Installation:
#   cp governance/hooks/pre-commit-documentation .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Bypass (emergency only):
#   git commit --no-verify

set -e

echo "üîç Validating documentation structure (ADR-010)..."

# Track violations
VIOLATIONS=0

# ============================================
# Rule 1: No new markdown files at root
# ============================================
ROOT_MD_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E "^[^/]+\.md$" || true)

ALLOWED_ROOT_FILES=(
    "CATALOG.md" "CLAUDE.md" "STATE.md" "DECISIONS.md"
    "USER-PREFERENCES.md" "ROADMAP.md" "QUICKSTART.md"
    "SYSTEM-CONFIGURATION.md" "AI-RUN-COMPANY.md" "claude.md"
    "gemini.md" "README.md"
)

if [ -n "$ROOT_MD_FILES" ]; then
    for file in $ROOT_MD_FILES; do
        # Check if file is in allowed list
        ALLOWED=false
        for allowed in "${ALLOWED_ROOT_FILES[@]}"; do
            if [ "$file" = "$allowed" ]; then
                ALLOWED=true
                break
            fi
        done

        if [ "$ALLOWED" = false ]; then
            echo "üö´ BLOCKED: Cannot add markdown file to root: $file"
            echo "   Suggested locations:"
            echo "     - work/plans-active/  (for active plans)"
            echo "     - work/adrs-active/   (for active ADRs)"
            echo "     - docs/guides/        (for guides)"
            echo "     - archive/YYYY-MM/    (for completed work)"
            VIOLATIONS=$((VIOLATIONS + 1))
        fi
    done
fi

# ============================================
# Rule 2: work/ files must have frontmatter
# ============================================
WORK_MD_FILES=$(git diff --cached --name-only | grep "^work/.*\.md$" || true)

for file in $WORK_MD_FILES; do
    if [ -f "$file" ]; then
        # Check first line is ---
        FIRST_LINE=$(head -1 "$file")
        if [ "$FIRST_LINE" != "---" ]; then
            echo "üö´ BLOCKED: Missing frontmatter in $file"
            echo "   All work/ documents require SOC2/ISO compliance metadata"
            echo "   See: work/README.md or plan file for template"
            VIOLATIONS=$((VIOLATIONS + 1))
        else
            # Check for compliance section
            if ! grep -q "^compliance:" "$file"; then
                echo "üö´ BLOCKED: Missing compliance metadata in $file"
                echo "   Required: compliance.soc2.controls and compliance.iso27001.controls"
                VIOLATIONS=$((VIOLATIONS + 1))
            fi
        fi
    fi
done

# ============================================
# Rule 3: ADR naming convention
# ============================================
ADR_FILES=$(git diff --cached --name-only | grep "^work/adrs-active/.*\.md$" || true)

for file in $ADR_FILES; do
    filename=$(basename "$file")
    if ! echo "$filename" | grep -qE "^(cm|km|g)-ADR-[0-9]{3}-.+\.md$"; then
        echo "‚ö†Ô∏è  WARNING: ADR naming convention violation: $file"
        echo "   Expected: {scope}-ADR-XXX-description.md"
        echo "   Example: cm-ADR-006-cme-gap-calculation.md"
        # Warning only, not blocking
    fi
done

# ============================================
# Rule 4: Plan naming convention
# ============================================
PLAN_FILES=$(git diff --cached --name-only | grep "^work/plans-active/.*\.md$" || true)

for file in $PLAN_FILES; do
    filename=$(basename "$file")
    if ! echo "$filename" | grep -qE "^(cm|km|g)-plan-.+\.md$"; then
        echo "‚ö†Ô∏è  WARNING: Plan naming convention violation: $file"
        echo "   Expected: {scope}-plan-description.md"
        echo "   Example: cm-plan-lambda-migration.md"
        # Warning only, not blocking
    fi
done

# ============================================
# Rule 5: Queue naming convention
# ============================================
QUEUE_FILES=$(git diff --cached --name-only | grep "^tasks/queues-active/.*\.json$" || true)

for file in $QUEUE_FILES; do
    filename=$(basename "$file")
    if ! echo "$filename" | grep -qE "^(cm|km|g)-queue-active\.json$"; then
        echo "üö´ BLOCKED: Queue naming convention violation: $file"
        echo "   Expected: {scope}-queue-active.json"
        echo "   Example: cm-queue-active.json"
        VIOLATIONS=$((VIOLATIONS + 1))
    fi
done

# ============================================
# Rule 6: Validate with Python validator (optional)
# ============================================
if command -v python3 &> /dev/null; then
    if [ -f "governance/validators/documentation_validator.py" ]; then
        # Run validator on changed files only (fast)
        # Full validation happens in CI
        echo "   Running Python validator..."
        # Note: Could extend validator to accept file list
    fi
fi

# ============================================
# Final verdict
# ============================================
if [ $VIOLATIONS -gt 0 ]; then
    echo ""
    echo "============================================"
    echo "‚ùå COMMIT BLOCKED: $VIOLATIONS violation(s)"
    echo "============================================"
    echo ""
    echo "Fix the violations above, or bypass with:"
    echo "  git commit --no-verify"
    echo ""
    echo "Note: Bypassing is tracked and may fail CI"
    echo "============================================"
    exit 1
fi

echo "‚úÖ Documentation structure validation passed"
exit 0
