{
  "project": "credentialmate",
  "sequence": 0,
  "fingerprints": [],
  "features": [
    {
      "id": "TASK-ADR006-001",
      "description": "Create calculate_gap_with_overlap() method in CMEComplianceService\n\nAdd new method in apps/backend-api/src/core/services/cme_compliance_service.py after line 1200:\n- Create TopicGap and CMEGapCalculation dataclasses\n- Implement overlap logic (max for overlapping topics, additive for separate topics)\n- Handle counts_toward_total field from CMERule\n- Return structured CMEGapCalculation result\n\nThis is the core SSOT method for gap calculations across all endpoints.",
      "file": "apps/backend-api/src/core/services/cme_compliance_service.py",
      "status": "pending",
      "tests": ["apps/backend-api/tests/unit/cme/test_gap_calculation.py"],
      "completion_promise": "FEATURE_COMPLETE",
      "max_iterations": 50,
      "type": "feature",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "FeatureBuilder",
      "source": "ADR-006 Phase 1",
      "priority": 0
    },
    {
      "id": "TASK-ADR006-002",
      "description": "Update calculate_compliance() to use calculate_gap_with_overlap()\n\nRefactor apps/backend-api/src/core/services/cme_compliance_service.py line 1306:\n- Replace naive subtraction gap calculation\n- Call self.calculate_gap_with_overlap() method\n- Pass topic_progress and state_rules\n- Store CMEGapCalculation result in compliance result\n\nEnsures /check endpoint uses same logic as /harmonize.",
      "file": "apps/backend-api/src/core/services/cme_compliance_service.py",
      "status": "pending",
      "tests": [],
      "completion_promise": "FEATURE_COMPLETE",
      "max_iterations": 50,
      "type": "feature",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "FeatureBuilder",
      "source": "ADR-006 Phase 1",
      "priority": 1
    },
    {
      "id": "TASK-ADR006-003",
      "description": "Refactor /harmonize endpoint to use calculate_gap_with_overlap()\n\nUpdate apps/backend-api/src/contexts/cme/api/compliance_endpoints.py lines 675-718:\n- Remove duplicate overlap logic from endpoint\n- Call service.calculate_gap_with_overlap() instead\n- Simplify endpoint code (reduce from 43 lines to ~10 lines)\n- Ensure response format unchanged\n\nDRY principle - remove duplicate logic from endpoint layer.",
      "file": "apps/backend-api/src/contexts/cme/api/compliance_endpoints.py",
      "status": "pending",
      "tests": [],
      "completion_promise": "FEATURE_COMPLETE",
      "max_iterations": 50,
      "type": "feature",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "FeatureBuilder",
      "source": "ADR-006 Phase 1",
      "priority": 2
    },
    {
      "id": "TASK-ADR006-004",
      "description": "Create comprehensive unit tests for calculate_gap_with_overlap()\n\nCreate apps/backend-api/tests/unit/cme/test_gap_calculation.py with tests:\n- test_separate_topics_are_additive() - Medical Errors (separate) adds to general gap\n- test_overlapping_topics_use_max() - Overlapping topics use max(general_gap, topic_gaps)\n- test_mixed_overlap_and_separate() - Combined scenario\n- test_dr_sehgal_florida_case() - Real-world case (51h total, 0h Medical Errors, 2h required)\n- test_no_topics_simple_subtraction() - Fallback to simple calculation\n\nTarget: 100% coverage of calculate_gap_with_overlap() method.",
      "file": "apps/backend-api/tests/unit/cme/test_gap_calculation.py",
      "status": "pending",
      "tests": [],
      "completion_promise": "TESTS_COMPLETE",
      "max_iterations": 50,
      "type": "test",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "TestWriter",
      "source": "ADR-006 Phase 1",
      "priority": 3
    },
    {
      "id": "TASK-ADR006-005",
      "description": "Update CME response schemas to include counts_toward_total field\n\nUpdate apps/backend-api/src/contexts/cme/schemas/cme_schemas.py:\n- Add counts_toward_total: bool field to TopicProgressResponse (default=True)\n- Add explanation: Optional[str] field to TopicProgressResponse\n- Create TopicGapResponse schema (topic, gap_hours, counts_toward_total, explanation)\n- Create CMEGapDetail schema (total_gap, general_gap, overlap_topic_gaps, separate_topic_gaps, calculation_method)\n- Add gap_detail: Optional[CMEGapDetail] to CMEComplianceResult\n\nPhase 2: API contract standardization.",
      "file": "apps/backend-api/src/contexts/cme/schemas/cme_schemas.py",
      "status": "pending",
      "tests": [],
      "completion_promise": "FEATURE_COMPLETE",
      "max_iterations": 50,
      "type": "feature",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "FeatureBuilder",
      "source": "ADR-006 Phase 2",
      "priority": 4
    },
    {
      "id": "TASK-ADR006-006",
      "description": "Populate counts_toward_total and explanation fields in service responses\n\nUpdate apps/backend-api/src/core/services/cme_compliance_service.py topic_progress loop (~line 1440):\n- Add counts_toward_total field from rule.counts_toward_total\n- Generate user-friendly explanation:\n  - If gap > 0 and counts_toward_total=True: 'These X.Xh count toward your Yh general CME requirement'\n  - If gap > 0 and counts_toward_total=False: 'These X.Xh are IN ADDITION to your Yh general requirement'\n- Add explanation field to topic_progress dict\n\nEnables frontend to display overlap badges.",
      "file": "apps/backend-api/src/core/services/cme_compliance_service.py",
      "status": "pending",
      "tests": [],
      "completion_promise": "FEATURE_COMPLETE",
      "max_iterations": 50,
      "type": "feature",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "FeatureBuilder",
      "source": "ADR-006 Phase 2",
      "priority": 5
    },
    {
      "id": "TASK-ADR006-007",
      "description": "Create integration test for endpoint parity (/harmonize vs /check)\n\nCreate apps/backend-api/tests/integration/test_cme_parity.py:\n- test_harmonize_check_parity_same_provider() - Call both endpoints, assert gap values match\n- test_harmonize_check_parity_multiple_states() - Test across FL, OH, CA\n- test_dr_sehgal_florida_gap_is_2h() - Specific test for known case\n- Use real provider data from test fixtures\n- Assert: harmonize_gap == check_gap (within 0.01h)\n\nCritical: Ensures Single Calculation Service Architecture works.",
      "file": "apps/backend-api/tests/integration/test_cme_parity.py",
      "status": "pending",
      "tests": [],
      "completion_promise": "TESTS_COMPLETE",
      "max_iterations": 50,
      "type": "test",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "TestWriter",
      "source": "ADR-006 Phase 2",
      "priority": 6
    },
    {
      "id": "TASK-ADR006-008",
      "description": "Remove client-side gap calculation from State Detail page\n\nUpdate apps/frontend-web/src/app/dashboard/states/[state]/page.tsx:\n- Remove useEffect hook that calculates generalCMEGap from topics (~line 85)\n- Remove client-side max() logic for overlapping topics\n- Use stateData.gap directly from API response\n- Update gap display to trust API value\n- Remove outdated comment about 'overlap logic'\n\nPhase 3: Frontend refactor - trust API, don't calculate client-side.",
      "file": "apps/frontend-web/src/app/dashboard/states/[state]/page.tsx",
      "status": "pending",
      "tests": ["apps/frontend-web/src/app/dashboard/states/__tests__/StatePage.test.tsx"],
      "completion_promise": "FEATURE_COMPLETE",
      "max_iterations": 50,
      "type": "feature",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "FeatureBuilder",
      "source": "ADR-006 Phase 3",
      "priority": 7
    },
    {
      "id": "TASK-ADR006-009",
      "description": "Add overlap badges to CME Compliance Table tooltips\n\nUpdate apps/frontend-web/src/components/dashboard/CMEComplianceTable.tsx:\n- Read counts_toward_total field from topic data\n- Update topic gap tooltips:\n  - If counts_toward_total=true: Show blue badge 'Overlaps with general CME'\n  - If counts_toward_total=false: Show orange badge 'Separate requirement (additive)'\n- Display explanation text from API if available\n- Add visual indicator (icon or colored dot) next to gap hours\n\nHelps users understand why gaps are calculated differently.",
      "file": "apps/frontend-web/src/components/dashboard/CMEComplianceTable.tsx",
      "status": "pending",
      "tests": [],
      "completion_promise": "FEATURE_COMPLETE",
      "max_iterations": 50,
      "type": "feature",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "FeatureBuilder",
      "source": "ADR-006 Phase 3",
      "priority": 8
    },
    {
      "id": "TASK-ADR006-010",
      "description": "Add frontend component test for State Detail page\n\nCreate apps/frontend-web/src/app/dashboard/states/__tests__/StatePage.test.tsx:\n- Mock API response with counts_toward_total fields\n- Render StatePage component\n- Assert: Gap displayed matches API response (no client-side calculation)\n- Assert: Tooltips show correct overlap badges\n- Test scenario: overlapping topic (blue badge) vs separate topic (orange badge)\n\nEnsures frontend correctly displays API data without modification.",
      "file": "apps/frontend-web/src/app/dashboard/states/__tests__/StatePage.test.tsx",
      "status": "pending",
      "tests": [],
      "completion_promise": "TESTS_COMPLETE",
      "max_iterations": 50,
      "type": "test",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "TestWriter",
      "source": "ADR-006 Phase 3",
      "priority": 9
    },
    {
      "id": "TASK-ADR006-011",
      "description": "Refactor generate_cme_v4.py to call backend API instead of local calculation\n\nUpdate scripts/generate_cme_v4.py:\n- Remove duplicate gap calculation logic (lines with overlap handling)\n- Add API client to call /api/v1/cme/compliance/check endpoint\n- Use gap value from API response\n- Remove local CMERule queries (use API data)\n- Add error handling for API failures\n\nPhase 4: Ad-hoc reports must use backend SSOT (ADR-005 compliance).",
      "file": "scripts/generate_cme_v4.py",
      "status": "pending",
      "tests": ["tests/integration/test_adhoc_parity.py"],
      "completion_promise": "FEATURE_COMPLETE",
      "max_iterations": 50,
      "type": "feature",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "FeatureBuilder",
      "source": "ADR-006 Phase 4",
      "priority": 10
    },
    {
      "id": "TASK-ADR006-012",
      "description": "Create integration test for ad-hoc report parity with API\n\nUpdate tests/integration/test_adhoc_parity.py:\n- Add test_adhoc_report_matches_api() method\n- Run generate_cme_v4.py for test provider\n- Call /check API for same provider\n- Parse report output, extract gap value\n- Assert: report_gap == api_gap (within 0.01h)\n- Test multiple providers (Dr. Sehgal, test300, test500)\n\nEnsures ad-hoc reports show same gaps as dashboard/API.",
      "file": "tests/integration/test_adhoc_parity.py",
      "status": "pending",
      "tests": [],
      "completion_promise": "TESTS_COMPLETE",
      "max_iterations": 50,
      "type": "test",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "TestWriter",
      "source": "ADR-006 Phase 4",
      "priority": 11
    },
    {
      "id": "TASK-ADR006-013",
      "description": "Create end-to-end test for Dr. Sehgal Florida consistency\n\nCreate apps/backend-api/tests/e2e/test_dr_sehgal_consistency.py:\n- test_florida_gap_consistency_across_all_endpoints()\n  - Call /harmonize for Dr. Sehgal\n  - Call /check for Dr. Sehgal + FL\n  - Run generate_cme_v4.py for Dr. Sehgal\n  - Parse all three sources, extract FL gap\n  - Assert: all three show 2.0h gap (not 4.0h)\n- test_ohio_zero_gap_consistency()\n  - Same test but for OH license (should be 0.0h gap)\n\nPhase 5: Validation that ADR-006 success criteria met.",
      "file": "apps/backend-api/tests/e2e/test_dr_sehgal_consistency.py",
      "status": "pending",
      "tests": [],
      "completion_promise": "TESTS_COMPLETE",
      "max_iterations": 50,
      "type": "test",
      "branch": "feature/adr-006-gap-calculation",
      "agent": "TestWriter",
      "source": "ADR-006 Phase 5",
      "priority": 12
    }
  ]
}
